local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local TS = game:GetService("TweenService")
local gui = Instance.new("ScreenGui")
gui.ResetOnSpawn = false
gui.Name = "TradeFreezeUI"
gui.Parent = Players.LocalPlayer:WaitForChild("PlayerGui")
gui.DisplayOrder = 1000

-- Main frame
local main = Instance.new("Frame")
main.Size = UDim2.new(0, 260, 0, 340)
main.Position = UDim2.new(0.5, -130, 0.5, -170)
main.BackgroundColor3 = Color3.fromRGB(22, 140, 128)
main.BackgroundTransparency = 0.1
main.BorderSizePixel = 0
main.Parent = gui
Instance.new("UICorner", main).CornerRadius = UDim.new(0, 18)

-- Draggable functionality (click and drag anywhere on the frame)
local dragging = false
local dragInput, mousePos, framePos

main.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        mousePos = input.Position
        framePos = main.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

UIS.InputChanged:Connect(function(input)
    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local delta = input.Position - mousePos
        main.Position = UDim2.new(
            framePos.X.Scale,
            framePos.X.Offset + delta.X,
            framePos.Y.Scale,
            framePos.Y.Offset + delta.Y
        )
    end
end)

-- Title
local label = Instance.new("TextLabel")
label.Size = UDim2.new(1, 0, 0, 38)
label.BackgroundTransparency = 1
label.Text = "ðŸ¤ Trade Freeze ðŸ§Š"
label.TextColor3 = Color3.fromRGB(255, 255, 255)
label.TextSize = 26
label.Font = Enum.Font.FredokaOne
label.Parent = main
label.TextYAlignment = Enum.TextYAlignment.Center

-- Profile Icon (Circle)
local profileFrame = Instance.new("Frame", main)
profileFrame.Size = UDim2.new(0, 90, 0, 90)
profileFrame.Position = UDim2.new(0.5, -45, 0, 38)
profileFrame.BackgroundColor3 = Color3.fromRGB(30, 60, 60)
profileFrame.BackgroundTransparency = 0
profileFrame.BorderSizePixel = 0
Instance.new("UICorner", profileFrame).CornerRadius = UDim.new(1, 0)

local avatarImage = Instance.new("ImageLabel", profileFrame)
avatarImage.Size = UDim2.new(1, -16, 1, -16)
avatarImage.Position = UDim2.new(0, 8, 0, 8)
avatarImage.BackgroundTransparency = 1
local DEFAULT_AVATAR = "rbxassetid://8560914936" -- Roblox default head icon
avatarImage.Image = DEFAULT_AVATAR

-- Player Dropdown (simulated)
local dropdown = Instance.new("TextButton", main)
dropdown.Size = UDim2.new(0.85, 0, 0, 32)
dropdown.Position = UDim2.new(0.5, -0.5*0.85*260, 0, 138)
dropdown.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
dropdown.Text = "select Player"
dropdown.Font = Enum.Font.FredokaOne
dropdown.TextSize = 20
dropdown.TextColor3 = Color3.fromRGB(220, 220, 220)
dropdown.AutoButtonColor = true
dropdown.ZIndex = 20
Instance.new("UICorner", dropdown).CornerRadius = UDim.new(0, 8)

-- Dropdown symbol
local dropSym = Instance.new("TextLabel", dropdown)
dropSym.Size = UDim2.new(0, 24, 1, 0)
dropSym.Position = UDim2.new(1, -28, 0, 0)
dropSym.BackgroundTransparency = 1
dropSym.Text = "â–¼"
dropSym.TextColor3 = Color3.fromRGB(180, 180, 200)
dropSym.TextSize = 20
dropSym.Font = Enum.Font.FredokaOne
dropSym.ZIndex = 22

-- Dropdown options
local optionsFrame = Instance.new("Frame", main)
optionsFrame.Size = UDim2.new(0.85, 0, 0, 0)
optionsFrame.Position = UDim2.new(0.5, -0.5*0.85*260, 0, 170)
optionsFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
optionsFrame.Visible = false
optionsFrame.ClipsDescendants = true
optionsFrame.ZIndex = 21
Instance.new("UICorner", optionsFrame).CornerRadius = UDim.new(0, 8)

local optionsLayout = Instance.new("UIListLayout", optionsFrame)
optionsLayout.Padding = UDim.new(0, 2)
optionsLayout.SortOrder = Enum.SortOrder.LayoutOrder

local selectedPlayer = nil
local function updateAvatar(p)
    if not p then
        avatarImage.Image = DEFAULT_AVATAR
        return
    end
    local thumb, ready = Players:GetUserThumbnailAsync(p.UserId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size150x150)
    if ready then
        avatarImage.Image = thumb
    else
        avatarImage.Image = DEFAULT_AVATAR
    end
end

local function populateDropdown()
    for _, child in ipairs(optionsFrame:GetChildren()) do
        if child:IsA("TextButton") then child:Destroy() end
    end
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= Players.LocalPlayer then
            local btn = Instance.new("TextButton")
            btn.Size = UDim2.new(1, 0, 0, 28)
            btn.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
            btn.Text = p.Name
            btn.Font = Enum.Font.FredokaOne
            btn.TextSize = 18
            btn.TextColor3 = Color3.fromRGB(255,255,255)
            btn.Parent = optionsFrame
            btn.AutoButtonColor = true
            btn.ZIndex = 22
            btn.MouseButton1Click:Connect(function()
                selectedPlayer = p
                dropdown.Text = p.Name
                updateAvatar(p)
                optionsFrame.Visible = false
                optionsFrame.Size = UDim2.new(0.85, 0, 0, 0)
            end)
        end
    end
end

populateDropdown()
Players.PlayerAdded:Connect(populateDropdown)
Players.PlayerRemoving:Connect(populateDropdown)

dropdown.MouseButton1Click:Connect(function()
    optionsFrame.Visible = not optionsFrame.Visible
    if optionsFrame.Visible then
        local count = #Players:GetPlayers() - 1
        optionsFrame.Size = UDim2.new(0.85, 0, 0, math.max(0, count*30))
    else
        optionsFrame.Size = UDim2.new(0.85, 0, 0, 0)
    end
end)

-- Close dropdown when clicking outside
UIS.InputBegan:Connect(function(input, processed)
    if processed then return end
    if optionsFrame.Visible and input.UserInputType == Enum.UserInputType.MouseButton1 then
        local mousePos = UIS:GetMouseLocation()
        local absPos = optionsFrame.AbsolutePosition
        local absSize = optionsFrame.AbsoluteSize
        if not (mousePos.X >= absPos.X and mousePos.X <= absPos.X + absSize.X and mousePos.Y >= absPos.Y and mousePos.Y <= absPos.Y + absSize.Y) then
            optionsFrame.Visible = false
            optionsFrame.Size = UDim2.new(0.85, 0, 0, 0)
        end
    end
end)

-- Button Data
local buttonData = {
    {text = "ðŸ§Š Freeze Trade", color = Color3.fromRGB(120, 108, 204), y = 190},
    {text = "Auto Accept", color = Color3.fromRGB(120, 90, 180), y = 232},
    {text = "Auto Add Items", color = Color3.fromRGB(60, 70, 110), y = 274},
}

local freezeTradeClicked = false
local autoAddItemsClicked = false
for i, btn in ipairs(buttonData) do
    local b = Instance.new("TextButton", main)
    b.Size = UDim2.new(0.92, 0, 0, 38)
    b.Position = UDim2.new(0.5, -0.46*260, 0, btn.y)
    b.BackgroundColor3 = btn.color
    b.Text = btn.text
    b.TextSize = 20
    b.Font = Enum.Font.FredokaOne
    b.TextColor3 = Color3.fromRGB(255, 255, 255)
    b.AutoButtonColor = true
    b.ZIndex = 10
    Instance.new("UICorner", b).CornerRadius = UDim.new(0, 8)
    if i == 1 then -- Freeze Trade button
        b.MouseButton1Click:Connect(function()
            local originalText = b.Text
            -- Removed countdown timer
            b.Text = originalText
            freezeTradeClicked = true
        end)
    elseif i == 2 then -- Auto Accept button
        b.Name = "AutoAcceptBtn"
        b.MouseButton1Click:Connect(function()
            local originalText = b.Text
            local originalColor = b.BackgroundColor3
            if not freezeTradeClicked then
                b.Text = "FREEZE TRADE FIRST"
                -- Removed wait
                b.Text = originalText
                return
            end
            if not autoAddItemsClicked then
                b.Text = "ADD ITEMS FIRST"
                -- Removed wait
                b.Text = originalText
                return
            end
            -- Removed countdown timer
            -- Removed random fail logic and waits
            b.Text = originalText
            b.BackgroundColor3 = originalColor
        end)
    elseif i == 3 then -- Auto Add Items button
        b.Name = "AutoAddItemsBtn"
        b.MouseButton1Click:Connect(function()
            local originalText = b.Text
            if not freezeTradeClicked then
                b.Text = "FREEZE TRADE FIRST"
                -- Removed wait
                b.Text = originalText
                return
            end
            -- Removed countdown timer
            b.Text = originalText
            autoAddItemsClicked = true
        end)
    end
end
